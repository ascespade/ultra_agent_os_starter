<!DOCTYPE html>
<script src="/env.js"></script>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ultra Agent OS - Admin Control Plane</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #0F172A;
  --secondary: #1E293B;
  --accent: #2563EB;
  --success: #16A34A;
  --warning: #D97706;
  --error: #DC2626;
  --background: #020617;
  --surface: #020617;
  --text-primary: #E5E7EB;
  --text-secondary: #9CA3AF;
  --border: rgba(148, 163, 184, 0.1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', system-ui, sans-serif;
  background: var(--background);
  color: var(--text-primary);
  font-weight: 400;
  line-height: 1.5;
}

#root {
  display: grid;
  grid-template-columns: 300px 1fr 350px;
  grid-template-rows: 60px 1fr 200px;
  height: 100vh;
  gap: 1px;
  background: var(--border);
}

.header {
  grid-column: 1 / -1;
  background: var(--secondary);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 20px;
  justify-content: space-between;
}

.header h1 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
}

.header-actions {
  display: flex;
  gap: 10px;
}

.btn {
  padding: 6px 12px;
  border: 1px solid var(--border);
  background: var(--primary);
  color: var(--text-primary);
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.btn:hover {
  background: var(--accent);
  color: white;
}

.btn.danger {
  background: var(--error);
  color: white;
}

.btn.success {
  background: var(--success);
  color: white;
}

.panel {
  background: var(--surface);
  display: flex;
  flex-direction: column;
}

#navigation {
  border-right: 1px solid var(--border);
}

#main-content {
  background: var(--primary);
}

#system-status {
  border-left: 1px solid var(--border);
}

#logs {
  grid-column: 1 / -1;
  border-top: 1px solid var(--border);
  background: var(--secondary);
}

.panel-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel-header h3 {
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-secondary);
  margin: 0;
}

.panel-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.nav-item {
  padding: 12px 20px;
  cursor: pointer;
  border-left: 3px solid transparent;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 10px;
}

.nav-item:hover {
  background: var(--secondary);
}

.nav-item.active {
  background: var(--secondary);
  border-left-color: var(--accent);
  color: var(--accent);
}

.nav-icon {
  width: 16px;
  height: 16px;
  opacity: 0.7;
}

.status-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
}

.status-online {
  background: var(--success);
  box-shadow: 0 0 4px var(--success);
}

.status-offline {
  background: var(--error);
  box-shadow: 0 0 4px var(--error);
}

.status-warning {
  background: var(--warning);
  box-shadow: 0 0 4px var(--warning);
}

.metric-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
}

.metric-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.metric-title {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  color: var(--text-secondary);
}

.metric-value {
  font-size: 24px;
  font-weight: 600;
  color: var(--text-primary);
}

.metric-change {
  font-size: 12px;
  font-weight: 500;
}

.metric-change.positive {
  color: var(--success);
}

.metric-change.negative {
  color: var(--error);
}

.job-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.job-item:hover {
  border-color: var(--accent);
}

.job-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.job-id {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: var(--text-secondary);
}

.job-status {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
}

.job-status.pending {
  background: var(--warning);
  color: white;
}

.job-status.running {
  background: var(--accent);
  color: white;
}

.job-status.completed {
  background: var(--success);
  color: white;
}

.job-status.failed {
  background: var(--error);
  color: white;
}

.job-message {
  font-size: 14px;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.job-meta {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: var(--text-secondary);
}

.log-container {
  height: 100%;
  overflow-y: auto;
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  line-height: 1.4;
}

.log-entry {
  padding: 4px 8px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 8px;
}

.log-timestamp {
  color: var(--text-secondary);
  min-width: 80px;
}

.log-level {
  min-width: 60px;
  font-weight: 600;
}

.log-level.INFO {
  color: var(--text-primary);
}

.log-level.WARN {
  color: var(--warning);
}

.log-level.ERROR {
  color: var(--error);
}

.log-message {
  flex: 1;
  color: var(--text-primary);
}

.config-section {
  margin-bottom: 24px;
}

.config-section h4 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.config-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}

.config-label {
  font-size: 12px;
  color: var(--text-secondary);
}

.config-value {
  font-size: 12px;
  color: var(--text-primary);
  font-family: 'JetBrains Mono', monospace;
}

.config-toggle {
  position: relative;
  width: 40px;
  height: 20px;
  background: var(--secondary);
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.config-toggle.active {
  background: var(--accent);
}

.config-toggle::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 16px;
  height: 16px;
  background: white;
  border-radius: 50%;
  transition: transform 0.2s ease;
}

.config-toggle.active::after {
  transform: translateX(20px);
}

.user-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid var(--border);
}

.user-info {
  flex: 1;
}

.user-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

.user-role {
  font-size: 12px;
  color: var(--text-secondary);
}

.user-actions {
  display: flex;
  gap: 8px;
}

.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--text-secondary);
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 12px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.hidden {
  display: none;
}

.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 12px;
  font-weight: 500;
  margin-bottom: 6px;
  color: var(--text-secondary);
}

.form-input {
  width: 100%;
  padding: 8px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 14px;
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 24px;
  max-width: 400px;
  width: 90%;
}

.modal-header {
  margin-bottom: 20px;
}

.modal-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
}

.modal-body {
  margin-bottom: 20px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}
</style>
</head>
<body>
<div id="root">
  <!-- Header -->
  <div class="header">
    <h1>Ultra Agent OS - Admin Control Plane</h1>
    <div class="header-actions">
      <span id="tenant-switcher-wrap" class="hidden" style="display:flex;align-items:center;gap:8px">
        <label for="tenant-select" style="font-size:12px;color:var(--text-secondary)">Tenant</label>
        <select id="tenant-select" class="form-input" style="width:auto;padding:4px 8px;min-width:120px" onchange="admin.onTenantChange(this.value)"></select>
      </span>
      <button class="btn" onclick="refreshData()">Refresh</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Navigation Panel: mandatory sections -->
  <div id="navigation" class="panel">
    <div class="panel-content">
      <div class="nav-item active" data-view="overview" onclick="showView('overview')">
        <span class="nav-icon">üìä</span>
        <span>System Overview</span>
      </div>
      <div class="nav-item" data-view="jobs" onclick="showView('jobs')">
        <span class="nav-icon">‚ö°</span>
        <span>Jobs &amp; Workers</span>
      </div>
      <div class="nav-item" data-view="dbredis" onclick="showView('dbredis')">
        <span class="nav-icon">üóÑÔ∏è</span>
        <span>Database &amp; Redis</span>
      </div>
      <div class="nav-item" data-view="integrations" onclick="showView('integrations')">
        <span class="nav-icon">üîå</span>
        <span>Integrations</span>
      </div>
      <div class="nav-item" data-view="security" onclick="showView('security')">
        <span class="nav-icon">üîí</span>
        <span>Security &amp; Auth</span>
      </div>
      <div class="nav-item" data-view="config" onclick="showView('config')">
        <span class="nav-icon">üîß</span>
        <span>Configuration</span>
      </div>
      <div class="nav-item" data-view="errors" onclick="showView('errors')">
        <span class="nav-icon">‚ö†Ô∏è</span>
        <span>Errors &amp; Alerts</span>
      </div>
      <div class="nav-item" data-view="plugins" onclick="showView('plugins')">
        <span class="nav-icon">üß©</span>
        <span>Plugin Manager</span>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="panel">
    <div class="panel-header">
      <h3 id="view-title">Dashboard</h3>
      <div id="view-actions"></div>
    </div>
    <div class="panel-content" id="view-content">
      <!-- Dynamic content will be loaded here -->
    </div>
  </div>

  <!-- System Status Panel -->
  <div id="system-status" class="panel">
    <div class="panel-header">
      <h3>System Status</h3>
      <span class="status-indicator" id="system-status-indicator"></span>
    </div>
    <div class="panel-content" id="system-status-content">
      <div class="loading">
        <div class="spinner"></div>
        Loading system status...
      </div>
    </div>
  </div>

  <!-- Live Logs Panel (WebSocket) -->
  <div id="logs" class="panel">
    <div class="panel-header">
      <h3>Live Logs (WebSocket)</h3>
      <button class="btn" onclick="clearLogs()">Clear</button>
    </div>
    <div class="log-container" id="log-container">
      <!-- Logs will be displayed here -->
    </div>
  </div>
</div>

<!-- Modals -->
<div id="modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modal-title">Modal Title</h3>
    </div>
    <div class="modal-body" id="modal-body">
      <!-- Modal content -->
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn success" id="modal-confirm" onclick="confirmModal()">Confirm</button>
    </div>
  </div>
</div>

<script>
class AdminControlPlane {
  constructor() {
    this.authToken = null;
    this.user = null;
    this.currentView = 'overview';
    this.websocket = null;
    this.refreshInterval = null;
    this.status = null;
    this.jobs = [];
    this.jobDetail = null;
    this.errors = [];
    this.tenants = [];
    this.selectedTenantId = null;
    this.init();
  }

  async init() {
    this.authToken = localStorage.getItem('authToken');
    if (!this.authToken) {
      this.showLoginModal();
    } else {
      try {
        const payload = JSON.parse(atob(this.authToken.split('.')[1]));
        this.user = { userId: payload.userId, username: payload.username, role: payload.role || 'user', tenantId: payload.tenantId || 'default' };
      } catch (e) {
        this.user = { username: '‚Äî', role: 'user', tenantId: 'default' };
      }
      this.selectedTenantId = localStorage.getItem('adminSelectedTenantId') || this.user.tenantId || 'default';
      await this.refreshData();
      if (this.user && this.user.role === 'admin') await this.loadTenants();
      this.connectWebSocket();
      this.startAutoRefresh();
    }
  }

  getApiHeaders() {
    const h = { 'Authorization': `Bearer ${this.authToken}` };
    if (this.user && this.user.role === 'admin' && this.selectedTenantId) {
      h['X-TENANT-ID'] = this.selectedTenantId;
    }
    return h;
  }

  async loadTenants() {
    try {
      const response = await fetch(`${window.API_URL}/api/admin/tenants`, { headers: this.getApiHeaders() });
      if (!response.ok) return;
      this.tenants = await response.json();
      const wrap = document.getElementById('tenant-switcher-wrap');
      const sel = document.getElementById('tenant-select');
      if (wrap && sel) {
        wrap.classList.remove('hidden');
        wrap.style.display = 'flex';
        sel.innerHTML = this.tenants.map(t => `<option value="${t.tenant_id}" ${t.tenant_id === this.selectedTenantId ? 'selected' : ''}>${(t.name || t.tenant_id)}</option>`).join('');
        if (!this.selectedTenantId && this.tenants.length) this.selectedTenantId = this.tenants[0].tenant_id;
      }
    } catch (e) {
      this.addError('Tenants', e.message);
    }
  }

  onTenantChange(tenantId) {
    this.selectedTenantId = tenantId || null;
    localStorage.setItem('adminSelectedTenantId', tenantId || '');
    this.refreshData();
    this.addLog('INFO', 'Switched tenant to ' + (tenantId || 'JWT default'));
  }

  async login(username, password) {
    try {
      const response = await fetch(`${window.API_URL}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      
      if (response.ok) {
        const data = await response.json();
        this.authToken = data.token;
        this.user = data.user || { username: username, role: 'admin', tenantId: 'default' };
        this.selectedTenantId = this.user.tenantId || 'default';
        localStorage.setItem('authToken', this.authToken);
        localStorage.setItem('adminSelectedTenantId', this.selectedTenantId || '');
        closeModal();
        await this.refreshData();
        if (this.user && this.user.role === 'admin') await this.loadTenants();
        this.connectWebSocket();
        this.startAutoRefresh();
      } else {
        const errBody = await response.json().catch(() => ({}));
        throw new Error(errBody.error || 'Login failed');
      }
    } catch (error) {
      console.error('Login error:', error);
      this.addError('Login failed', error.message);
      this.addLog('ERROR', 'Login failed: ' + error.message);
      alert('Login failed. Please check your credentials.');
    }
  }

  logout() {
    localStorage.removeItem('authToken');
    this.authToken = null;
    if (this.websocket) {
      this.websocket.close();
    }
    if (this.refreshInterval) {
      clearInterval(this.refreshInterval);
    }
    this.showLoginModal();
  }

  showLoginModal() {
    const modal = document.getElementById('modal');
    const title = document.getElementById('modal-title');
    const body = document.getElementById('modal-body');
    
    title.textContent = 'Admin Login';
    body.innerHTML = `
      <div class="form-group">
        <label class="form-label">Username</label>
        <input type="text" class="form-input" id="login-username" value="admin">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="login-password">
      </div>
    `;
    
    modal.classList.remove('hidden');
    document.getElementById('modal-confirm').onclick = () => {
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      this.login(username, password);
    };
  }

  async refreshData() {
    await Promise.all([this.fetchStatus(), this.fetchJobs()]);
    this.updateSystemStatus();
    this.loadCurrentView();
  }

  async fetchStatus() {
    try {
      const response = await fetch(`${window.API_URL}/api/adapters/status`, {
        headers: this.getApiHeaders()
      });
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error || 'Status check failed');
      }
      this.status = await response.json();
    } catch (error) {
      this.addError('Adapter status', error.message);
      this.addLog('ERROR', 'Failed to fetch status: ' + error.message);
      this.status = null;
    }
  }

  async fetchJobs() {
    try {
      const response = await fetch(`${window.API_URL}/api/jobs`, {
        headers: { 'Authorization': `Bearer ${this.authToken}` }
      });
      if (!response.ok) throw new Error('Jobs fetch failed');
      this.jobs = await response.json();
    } catch (error) {
      this.addError('Jobs list', error.message);
      this.addLog('ERROR', 'Failed to fetch jobs: ' + error.message);
      this.jobs = [];
    }
  }

  addError(title, message) {
    this.errors.push({ title, message, at: new Date().toISOString() });
    if (this.errors.length > 100) this.errors.shift();
    this.loadCurrentView();
  }

  connectWebSocket() {
    const wsPort = window.WS_PORT || 3011;
    const wsUrl = (window.API_URL.replace(/^http/, 'ws').replace(/:\d+/, '') || 'ws://localhost') + ':' + wsPort;
    this.websocket = new WebSocket(wsUrl);
    
    this.websocket.onopen = () => {
      console.log('WebSocket connected');
      this.addLog('INFO', 'WebSocket connected to admin control plane');
    };
    
    this.websocket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      this.handleWebSocketMessage(data);
    };
    
    this.websocket.onclose = () => {
      console.log('WebSocket disconnected');
      this.addLog('WARN', 'WebSocket disconnected, attempting reconnect...');
      setTimeout(() => this.connectWebSocket(), 5000);
    };
    
    this.websocket.onerror = (error) => {
      console.error('WebSocket error:', error);
      this.addError('WebSocket', 'Connection error');
      this.addLog('ERROR', 'WebSocket connection error');
    };
  }

  handleWebSocketMessage(data) {
    if (data.type === 'log') {
      const msg = data.message != null ? data.message : (data.description || JSON.stringify(data));
      this.addLog(data.level || 'INFO', msg);
    } else if (data.type === 'job_status') {
      this.addLog('INFO', `Job ${data.jobId}: ${data.status || ''}`);
    } else {
      this.addLog('INFO', JSON.stringify(data));
    }
  }

  addLog(level, message) {
    const container = document.getElementById('log-container');
    const timestamp = new Date().toLocaleTimeString();
    const text = typeof message === 'string' ? message : (message && typeof message === 'object' ? (message.description || message.message || JSON.stringify(message)) : String(message));
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `
      <span class="log-timestamp">${timestamp}</span>
      <span class="log-level ${level}">${level}</span>
      <span class="log-message">${text.replace(/</g, '&lt;')}</span>
    `;
    container.appendChild(logEntry);
    container.scrollTop = container.scrollHeight;
    while (container.children.length > 100) container.removeChild(container.firstChild);
  }

  clearLogs() {
    document.getElementById('log-container').innerHTML = '';
    this.addLog('INFO', 'Logs cleared by admin');
  }

  startAutoRefresh() {
    this.refreshInterval = setInterval(() => {
      this.refreshData();
    }, 30000);
  }

  showView(viewName) {
    this.currentView = viewName;
    
    // Update navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
    
    // Update header
    document.getElementById('view-title').textContent = viewName.charAt(0).toUpperCase() + viewName.slice(1);
    
    // Load view content
    this.loadCurrentView();
  }

  loadCurrentView() {
    const content = document.getElementById('view-content');
    const titles = { overview: 'System Overview', jobs: 'Jobs & Workers', dbredis: 'Database & Redis', integrations: 'Integrations Status', security: 'Security & Auth Health', config: 'Configuration (read-only)', errors: 'Error & Alerts View', plugins: 'Plugin Manager' };
    document.getElementById('view-title').textContent = titles[this.currentView] || this.currentView;
    switch (this.currentView) {
      case 'overview': this.loadOverview(content); break;
      case 'jobs': this.loadJobs(content); break;
      case 'dbredis': this.loadDbRedis(content); break;
      case 'integrations': this.loadIntegrations(content); break;
      case 'security': this.loadSecurity(content); break;
      case 'config': this.loadConfig(content); break;
      case 'errors': this.loadErrors(content); break;
      case 'plugins': this.loadPlugins(content); break;
      default: this.loadOverview(content);
    }
  }

  async loadPlugins(container) {
    container.innerHTML = '<div class="loading"><div class="spinner"></div> Loading plugins‚Ä¶</div>';
    try {
      const response = await fetch(`${window.API_URL}/api/plugins`, { headers: this.getApiHeaders() });
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error || 'Failed to load plugins');
      }
      const data = await response.json();
      const plugins = data.plugins || [];
      const errors = data.errors || [];
      if (plugins.length === 0 && errors.length === 0) {
        container.innerHTML = '<div class="loading">No plugins discovered. Add plugins to the plugin directory and refresh.</div>';
        return;
      }
      let html = '';
      if (errors.length) {
        html += '<div class="metric-card" style="margin-bottom:16px"><div class="metric-title" style="color:var(--warning)">Discovery errors</div><ul style="font-size:12px;color:var(--text-secondary);margin:8px 0 0 0;padding-left:20px">' + errors.map(e => `<li>${(e.plugin || '')}: ${(e.error || '')}</li>`).join('') + '</ul></div>';
      }
      html += '<div class="metric-card"><div class="metric-title">Plugins (tenant-scoped)</div><p style="font-size:12px;color:var(--text-secondary);margin:8px 0 12px 0">Enable/disable applies to current tenant. Signed plugins only.</p>';
      plugins.forEach(p => {
        const statusClass = p.enabled ? 'status-online' : 'status-offline';
        const validBadge = p.valid ? '<span style="color:var(--success);font-size:11px">valid</span>' : '<span style="color:var(--error);font-size:11px">invalid</span>';
        const btn = p.enabled
          ? `<button class="btn danger" onclick="admin.pluginDisable('${p.id}')">Disable</button>`
          : `<button class="btn success" onclick="admin.pluginEnable('${p.id}')" ${!p.valid ? 'disabled title="Fix validation errors first"' : ''}>Enable</button>`;
        const validationErr = (p.validationErrors && p.validationErrors.length) ? '<div style="font-size:11px;color:var(--error);margin-top:4px">' + p.validationErrors.join('; ') + '</div>' : '';
        html += `
          <div class="job-item" style="margin-bottom:12px">
            <div class="job-header">
              <span class="job-id">${p.name} v${p.version}</span>
              <span class="status-indicator ${statusClass}"></span>
              ${validBadge}
            </div>
            <div class="job-message">${(p.description || p.type || '').substring(0, 120)}</div>
            <div class="config-item"><span class="config-label">Type</span><span class="config-value">${p.type || '‚Äî'}</span></div>
            <div class="config-item"><span class="config-label">Permissions</span><span class="config-value">${(p.permissions || []).join(', ') || '‚Äî'}</span></div>
            ${validationErr}
            <div style="margin-top:12px">${btn}</div>
          </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    } catch (e) {
      this.addError('Plugins', e.message);
      container.innerHTML = '<div class="loading" style="color:var(--error)">' + (e.message || 'Failed to load plugins') + '</div>';
    }
  }

  async pluginEnable(pluginId) {
    try {
      const response = await fetch(`${window.API_URL}/api/plugins/${encodeURIComponent(pluginId)}/enable`, {
        method: 'POST',
        headers: this.getApiHeaders()
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) throw new Error(data.error || 'Enable failed');
      this.addLog('INFO', 'Plugin enabled: ' + pluginId);
      this.loadPlugins(document.getElementById('view-content'));
    } catch (e) {
      this.addError('Plugin enable', e.message);
      this.addLog('ERROR', 'Plugin enable: ' + e.message);
      alert('Enable failed: ' + e.message);
    }
  }

  async pluginDisable(pluginId) {
    try {
      const response = await fetch(`${window.API_URL}/api/plugins/${encodeURIComponent(pluginId)}/disable`, {
        method: 'POST',
        headers: this.getApiHeaders()
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) throw new Error(data.error || 'Disable failed');
      this.addLog('INFO', 'Plugin disabled: ' + pluginId);
      this.loadPlugins(document.getElementById('view-content'));
    } catch (e) {
      this.addError('Plugin disable', e.message);
      this.addLog('ERROR', 'Plugin disable: ' + e.message);
      alert('Disable failed: ' + e.message);
    }
  }

  loadOverview(container) {
    const s = this.status;
    if (!s) { container.innerHTML = '<div class="loading">No status data. Click Refresh.</div>'; return; }
    const core = s.core || {};
    const redis = s.redis || {};
    const uptimeSec = core.uptime != null ? Math.floor(core.uptime) : 0;
    const mem = core.memory || {};
    const heapMB = mem.heapUsed != null ? (mem.heapUsed / 1024 / 1024).toFixed(1) : '‚Äî';
    container.innerHTML = `
      <div class="metric-card">
        <div class="metric-header"><span class="metric-title">Core Status</span></div>
        <div class="metric-value">${core.status || '‚Äî'}</div>
        <div class="config-item"><span class="config-label">Message</span><span class="config-value">${core.message || '‚Äî'}</span></div>
      </div>
      <div class="metric-card">
        <div class="metric-header"><span class="metric-title">Uptime (seconds)</span></div>
        <div class="metric-value">${uptimeSec}</div>
      </div>
      <div class="metric-card">
        <div class="metric-header"><span class="metric-title">Heap Used (MB)</span></div>
        <div class="metric-value">${heapMB}</div>
      </div>
      <div class="metric-card">
        <div class="metric-header"><span class="metric-title">Queue Length</span></div>
        <div class="metric-value">${redis.queue_length != null ? redis.queue_length : '‚Äî'}</div>
        <div class="config-item"><span class="config-label">Queue Status</span><span class="config-value">${redis.queue_status || '‚Äî'}</span></div>
      </div>
      <div class="metric-card">
        <div class="metric-header"><span class="metric-title">Jobs in List</span></div>
        <div class="metric-value">${this.jobs.length}</div>
      </div>
    `;
  }

  loadJobs(container) {
    if (this.jobDetail) {
      const j = this.jobDetail;
      const statusClass = (j.status || '').toLowerCase();
      container.innerHTML = `
        <div class="panel-header" style="margin-bottom:16px">
          <button class="btn" onclick="admin.jobDetail=null; admin.loadCurrentView()">‚Üê Back to list</button>
        </div>
        <div class="job-item">
          <div class="job-header">
            <span class="job-id">${j.id}</span>
            <span class="job-status ${statusClass}">${j.status}</span>
          </div>
          <div class="config-item"><span class="config-label">Type</span><span class="config-value">${j.type || '‚Äî'}</span></div>
          <div class="config-item"><span class="config-label">Created</span><span class="config-value">${j.created_at || '‚Äî'}</span></div>
          <div class="config-item"><span class="config-label">Updated</span><span class="config-value">${j.updated_at || '‚Äî'}</span></div>
          ${j.error_message ? `<div class="config-item"><span class="config-label">Error</span><span class="config-value" style="color:var(--error)">${j.error_message}</span></div>` : ''}
          <pre class="config-value" style="margin-top:12px;white-space:pre-wrap;word-break:break-all">${JSON.stringify({ input_data: j.input_data, output_data: j.output_data }, null, 2)}</pre>
        </div>
      `;
      return;
    }
    if (this.jobs.length === 0) {
      container.innerHTML = '<div class="loading">No jobs. Data from /api/jobs.</div>';
      return;
    }
    container.innerHTML = this.jobs.map(job => {
      const msg = (job.input_data && typeof job.input_data === 'object' && job.input_data.message) ? job.input_data.message : (job.input_data && typeof job.input_data === 'string' ? job.input_data : job.id);
      const statusClass = (job.status || '').toLowerCase();
      return `<div class="job-item" onclick="admin.selectJob('${job.id}')">
        <div class="job-header">
          <span class="job-id">${(job.id || '').substring(0, 8)}‚Ä¶</span>
          <span class="job-status ${statusClass}">${job.status || '‚Äî'}</span>
        </div>
        <div class="job-message">${String(msg).substring(0, 80)}</div>
        <div class="job-meta">
          <span>${job.created_at ? new Date(job.created_at).toLocaleString() : '‚Äî'}</span>
          <span>${job.type || '‚Äî'}</span>
        </div>
      </div>`;
    }).join('');
  }

  async selectJob(jobId) {
    try {
      const response = await fetch(`${window.API_URL}/api/jobs/${jobId}`, { headers: this.getApiHeaders() });
      if (!response.ok) throw new Error('Failed to load job');
      this.jobDetail = await response.json();
      this.loadCurrentView();
    } catch (e) {
      this.addError('Job detail', e.message);
      this.addLog('ERROR', 'Job detail: ' + e.message);
    }
  }

  loadDbRedis(container) {
    const s = this.status;
    if (!s) { container.innerHTML = '<div class="loading">No status data. Click Refresh.</div>'; return; }
    const db = s.database || {};
    const redis = s.redis || {};
    container.innerHTML = `
      <div class="config-section">
        <h4>Database (PostgreSQL)</h4>
        <div class="config-item">
          <span class="config-label">Status</span>
          <span class="config-value">
            <span class="status-indicator ${db.available ? 'status-online' : 'status-offline'}"></span>
            ${db.status || '‚Äî'} ${db.type ? '(' + db.type + ')' : ''}
          </span>
        </div>
        ${db.error ? `<div class="config-item"><span class="config-label">Error</span><span class="config-value" style="color:var(--error)">${db.error}</span></div>` : ''}
      </div>
      <div class="config-section">
        <h4>Redis</h4>
        <div class="config-item">
          <span class="config-label">Status</span>
          <span class="config-value">
            <span class="status-indicator ${redis.available ? 'status-online' : 'status-offline'}"></span>
            ${redis.status || '‚Äî'}
          </span>
        </div>
        <div class="config-item"><span class="config-label">Queue length</span><span class="config-value">${redis.queue_length != null ? redis.queue_length : '‚Äî'}</span></div>
        <div class="config-item"><span class="config-label">Queue status</span><span class="config-value">${redis.queue_status || '‚Äî'}</span></div>
        ${redis.error ? `<div class="config-item"><span class="config-label">Error</span><span class="config-value" style="color:var(--error)">${redis.error}</span></div>` : ''}
      </div>
    `;
  }

  loadIntegrations(container) {
    const s = this.status;
    if (!s || !s.adapters) { container.innerHTML = '<div class="loading">No status data. Click Refresh.</div>'; return; }
    const a = s.adapters;
    const ollama = a.ollama || {};
    const docker = a.docker || {};
    container.innerHTML = `
      <div class="config-section">
        <h4>Ollama (LLM)</h4>
        <div class="config-item">
          <span class="config-label">Status</span>
          <span class="config-value">
            <span class="status-indicator ${ollama.available ? 'status-online' : 'status-warning'}"></span>
            ${ollama.status || '‚Äî'}
          </span>
        </div>
      </div>
      <div class="config-section">
        <h4>Docker</h4>
        <div class="config-item">
          <span class="config-label">Status</span>
          <span class="config-value">
            <span class="status-indicator ${docker.available ? 'status-online' : 'status-warning'}"></span>
            ${docker.status || '‚Äî'}
          </span>
        </div>
      </div>
    `;
  }

  loadSecurity(container) {
    const user = this.user || { username: '‚Äî', role: '‚Äî' };
    const tokenValid = !!this.authToken && this.status != null;
    container.innerHTML = `
      <div class="config-section">
        <h4>Auth Health</h4>
        <div class="config-item">
          <span class="config-label">Logged in as</span>
          <span class="config-value">${user.username}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Role</span>
          <span class="config-value">${user.role}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Token valid</span>
          <span class="config-value">
            <span class="status-indicator ${tokenValid ? 'status-online' : 'status-offline'}"></span>
            ${tokenValid ? 'Yes (API responded)' : 'No or not checked'}
          </span>
        </div>
        <button class="btn danger" style="margin-top:12px" onclick="logout()">Logout</button>
      </div>
    `;
  }

  maskConfigValue(val) {
    if (val == null || val === '') return '‚Äî';
    const s = String(val);
    if (s.length <= 8) return '***';
    return s.substring(0, 3) + '***' + s.substring(s.length - 2);
  }

  loadConfig(container) {
    const s = this.status;
    if (!s || !s.adapters) { container.innerHTML = '<div class="loading">No status data. Click Refresh. Configuration is read-only (no backend changes).</div>'; return; }
    const ollama = (s.adapters.ollama || {}).url;
    const docker = (s.adapters.docker || {}).socket;
    container.innerHTML = `
      <div class="config-section">
        <h4>Configuration (read-only, masked)</h4>
        <div class="config-item">
          <span class="config-label">Ollama URL</span>
          <span class="config-value">${this.maskConfigValue(ollama)}</span>
        </div>
        <div class="config-item">
          <span class="config-label">Docker socket</span>
          <span class="config-value">${this.maskConfigValue(docker)}</span>
        </div>
        <p style="margin-top:16px;color:var(--text-secondary);font-size:12px">No toggles or actions here; core is read-only. Use Refresh to reload.</p>
      </div>
    `;
  }

  loadErrors(container) {
    if (this.errors.length === 0) {
      container.innerHTML = '<div class="loading">No errors recorded.</div>';
      return;
    }
    container.innerHTML = `
      <button class="btn" onclick="admin.errors=[]; admin.loadCurrentView(); admin.addLog('INFO','Errors cleared')">Clear errors</button>
      <div style="margin-top:16px">
        ${this.errors.slice().reverse().map(e => `
          <div class="job-item" style="border-left:3px solid var(--error)">
            <div class="job-header"><span class="metric-title">${e.title}</span><span class="config-value">${e.at}</span></div>
            <div class="job-message">${e.message}</div>
          </div>
        `).join('')}
      </div>
    `;
  }

  updateSystemStatus() {
    const statusContent = document.getElementById('system-status-content');
    const statusIndicator = document.getElementById('system-status-indicator');
    if (!this.status) {
      statusContent.innerHTML = '<div class="loading">Loading‚Ä¶</div>';
      statusIndicator.className = 'status-indicator status-warning';
      return;
    }
    const db = this.status.database || {};
    const redis = this.status.redis || {};
    let statusClass = 'status-online';
    let statusText = 'Operational';
    if (!db.available || !redis.available) {
      statusClass = 'status-offline';
      statusText = 'Critical offline';
    } else if (!(this.status.adapters || {}).ollama?.available || !(this.status.adapters || {}).docker?.available) {
      statusClass = 'status-warning';
      statusText = 'Adapters partial';
    }
    statusIndicator.className = `status-indicator ${statusClass}`;
    statusContent.innerHTML = `
      <div class="config-item">
        <span class="config-label">Database</span>
        <span class="config-value"><span class="status-indicator ${db.available ? 'status-online' : 'status-offline'}"></span> ${db.status || '‚Äî'}</span>
      </div>
      <div class="config-item">
        <span class="config-label">Redis</span>
        <span class="config-value"><span class="status-indicator ${redis.available ? 'status-online' : 'status-offline'}"></span> ${redis.status || '‚Äî'}</span>
      </div>
      <div class="config-item">
        <span class="config-label">Queue</span>
        <span class="config-value">${redis.queue_length != null ? redis.queue_length : '‚Äî'}</span>
      </div>
      <div class="config-item">
        <span class="config-label">Overall</span>
        <span class="config-value">${statusText}</span>
      </div>
    `;
  }
}

// Global functions
let admin;

function showView(viewName) {
  admin.showView(viewName);
}

function refreshData() {
  admin.refreshData();
  admin.addLog('INFO', 'Data refreshed by admin');
}

function logout() {
  admin.logout();
}

function clearLogs() {
  admin.clearLogs();
}

function closeModal() {
  document.getElementById('modal').classList.add('hidden');
}

function confirmModal() {
  // Handle modal confirmation
}

// Initialize admin control plane
document.addEventListener('DOMContentLoaded', () => {
  admin = new AdminControlPlane();
});
</script>
</body>
</html>
