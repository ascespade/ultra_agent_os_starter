{
  "$schema": "https://railway.app/railway.schema.json",
  "name": "Ultra Agent OS",
  "description": "MiniMax-like Agent OS with API, UI, Worker, PostgreSQL & Redis",
  "deploy": {
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  },
  "services": [
    {
      "name": "ultra-agent-api",
      "source": ".",
      "dockerfilePath": "Dockerfile.api",
      "environment": ["production"],
      "healthcheck": {
        "path": "/health",
        "interval": 30,
        "timeout": 10,
        "retries": 5,
        "startPeriod": 60
      },
      "dependsOn": ["ultra-agent-db", "ultra-agent-redis"],
      "description": "Core Backend API - Authentication, orchestration, memory API, WebSocket gateway",
      "variables": {
        "NODE_ENV": "production",
        "PORT": "3000",
        "DATABASE_URL": "${{ultra-agent-db.DATABASE_URL}}",
        "REDIS_URL": "${{ultra-agent-redis.REDIS_URL}}",
        "INTERNAL_API_KEY": "${{secrets.INTERNAL_API_KEY}}",
        "JWT_SECRET": "${{secrets.JWT_SECRET}}",
        "DATA_DIR": "/data/agent",
        "OLLAMA_URL": "http://localhost:11434",
        "WS_PORT": "3010"
      }
    },
    {
      "name": "ultra-agent-ui",
      "source": ".",
      "dockerfilePath": "Dockerfile.dashboard",
      "environment": ["production"],
      "healthcheck": {
        "path": "/dashboard-health",
        "interval": 30,
        "timeout": 10,
        "retries": 5,
        "startPeriod": 20
      },
      "dependsOn": ["ultra-agent-api"],
      "description": "Dashboard Frontend - User interface and dashboard views",
      "variables": {
        "NODE_ENV": "production",
        "PORT": "3000",
        "VITE_API_URL": "/api",
        "API_INTERNAL_URL": "${{ultra-agent-api.RAILWAY_PRIVATE_URL}}"
      }
    },
    {
      "name": "ultra-agent-worker",
      "source": ".",
      "dockerfilePath": "Dockerfile.worker",
      "environment": ["production"],
      "healthcheck": {
        "command": "test -f /tmp/worker-health || (ps aux | grep -v grep | grep -E 'worker\\.js|node.*worker' > /dev/null && touch /tmp/worker-health) || exit 1",
        "interval": 15,
        "timeout": 5,
        "retries": 20,
        "startPeriod": 120
      },
      "dependsOn": ["ultra-agent-db", "ultra-agent-api"],
      "description": "Background Worker - Job execution and orchestration processing",
      "variables": {
        "NODE_ENV": "production",
        "DATABASE_URL": "${{ultra-agent-db.DATABASE_URL}}",
        "INTERNAL_API_KEY": "${{secrets.INTERNAL_API_KEY}}",
        "JWT_SECRET": "${{secrets.JWT_SECRET}}",
        "DATA_DIR": "/data/agent",
        "OLLAMA_URL": "http://localhost:11434",
        "DOCKER_HOST": "unix:///var/run/docker.sock"
      }
    }
  ],
  "database": {
    "ultra-agent-db": {
      "version": "15",
      "multiple": false,
      "generator": "POSTGRES"
    },
    "ultra-agent-redis": {
      "version": "7",
      "multiple": false,
      "generator": "REDIS"
    }
  },
  "secrets": {
    "description": "Required secrets for Ultra Agent OS deployment",
    "INTERNAL_API_KEY": "ultra-agent-internal-api-key-change-in-production",
    "JWT_SECRET": "ultra-agent-os-jwt-secret-change-in-production"
  }
}
