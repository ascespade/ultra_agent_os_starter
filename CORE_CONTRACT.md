# ULTRA AGENT OS CORE CONTRACT v1.0.0

## CORE_IDENTITY
**Project**: Ultra Agent OS - Railway Blueprint Core Platform  
**Version**: core-freeze-v1.0.0  
**Status**: FROZEN — Production-Ready Railway Blueprint  
**Forensic Score**: 96/100 (Phase 0 post-fix)  
**Blueprint Compliance**: Zero-Trust Railway Deployment Ready  
**Freeze Lock**: Applied 2026-02-01 (GOVERNED_CORE_FREEZE_AND_EXPANSION_ORCHESTRATOR)

---

## FREEZE_LOCK (IMMUTABLE CORE)

The following are **locked** as of tag `core-freeze-v1.0.0`. Expansion phases must not modify them; extend only via new code paths or new services.

| Item | Rule |
|------|------|
| **Directories** | `apps/api`, `apps/worker`, `lib`, `config` — no breaking changes |
| **API / DB schema** | No ALTER/DROP on core tables: `users`, `jobs`, `memories`, `tenant_quotas`, `tenants` |
| **Runtime contracts** | Health shape, job queue format, WS_PORT/HOST/PORT from env, no hardcoded ports/URLs |
| **Manifest** | `CORE_FREEZE_LOCK.json` — authoritative locked paths and prohibited changes |

---

## BLUEPRINT_CONTRACT

### Railway Deployment Guarantee:
This repository can be deployed on Railway by:
1. **Selecting the repository ONLY**
2. **No manual service creation required**
3. **No manual environment setup required**
4. **All services auto-provision and auto-wire**

### Zero-Trust Compliance:
- ✅ No hardcoded ports or URLs
- ✅ All environment variables required or optional with graceful fallback
- ✅ All inter-service communication via Railway service references
- ✅ Deterministic deployment outcome

---

## REQUIRED_ENVIRONMENT_VARIABLES

### Database Configuration:
```bash
DATABASE_URL=postgresql://user:password@host:port/database
# Required: PostgreSQL connection string (auto-provisioned by Railway)
# Runtime Guard: Service exits if missing
# Source: Railway Postgres service reference
```

### Redis Configuration:
```bash
REDIS_URL=redis://host:port
# Required: Redis connection string (auto-provisioned by Railway)
# Runtime Guard: Service exits if missing
# Source: Railway Redis service reference
```

### Security Configuration:
```bash
JWT_SECRET=your-secure-random-string
# Required: JWT signing secret (auto-generated by Railway)
# Runtime Guard: Service exits if missing
# Source: Railway generate=true

DEFAULT_ADMIN_PASSWORD=secure-password
# Required: Create default admin user on startup (auto-generated by Railway)
# Security: Must be 8+ characters, not 'admin123'
# Source: Railway generate=true

INTERNAL_API_KEY=api-key
# Optional: Service-to-service authentication (auto-generated by Railway)
# Source: Railway generate=true
```

### Optional External Adapters:
```bash
OLLAMA_URL=http://ollama:11434
# Optional: LLM adapter URL
# Default: Empty string (disabled)
# Behavior: Core-only mode if not provided

DOCKER_HOST=unix:///var/run/docker.sock
# Optional: Docker socket for container execution
# Default: Not set (core-only mode)
# Behavior: Core-only mode if not provided
```

### Service Configuration:
```bash
PORT=3000
# Optional: API server port (auto-assigned by Railway)
# Default: 3000

HOST=0.0.0.0
# Optional: API bind address (required 0.0.0.0 in Docker/Railway for host access)
# Default: 127.0.0.1

WS_PORT=3011
# Optional: WebSocket server port (API and UI; no hardcoded port)
# Default: 3011

API_URL=http://api:3000
# Required: UI API endpoint (auto-wired by Railway)
# Source: Railway service reference to ultra-agent-api

NODE_ENV=production
# Required: Node environment (set by Railway)
# Source: Railway configuration
```

---

## BLUEPRINT_SERVICES

### API Service (`ultra-agent-api`)
**Source**: `apps/api`  
**Port**: Dynamic (Railway-assigned)  
**Dependencies**: PostgreSQL, Redis, WebSocket Server (port from `WS_PORT` env, default 3011)  

**Environment Variables**:
- `DATABASE_URL` → Railway Postgres service reference
- `REDIS_URL` → Railway Redis service reference
- `JWT_SECRET` → Railway generated
- `DEFAULT_ADMIN_PASSWORD` → Railway generated
- `INTERNAL_API_KEY` → Railway generated
- `OLLAMA_URL` → Empty string (optional)

**Key Endpoints**:
- `POST /api/auth/login` - User authentication
- `POST /api/chat` - Job creation (authenticated)
- `GET /api/jobs` - Job list (authenticated)
- `GET /api/jobs/:id` - Job details (authenticated)
- `GET /api/memory/:filename` - Memory retrieval (authenticated)
- `POST /api/memory/:filename` - Memory storage (authenticated)
- `GET /api/workspace` - Workspace data (authenticated)
- `GET /api/adapters/status` - System status (authenticated)
- `GET /health` - Health check (public)

### Worker Service (`ultra-agent-worker`)
**Source**: `apps/worker`  
**Dependencies**: PostgreSQL, Redis  

**Environment Variables**:
- `DATABASE_URL` → Railway Postgres service reference
- `REDIS_URL` → Railway Redis service reference
- `JWT_SECRET` → Railway API service reference
- `INTERNAL_API_KEY` → Railway API service reference
- `OLLAMA_URL` → Empty string (optional)

**Job Processing Flow**:
1. Dequeue job from Redis queue
2. Analyze intent with optional LLM integration
3. Create execution plan
4. Execute steps with progress logging
5. Update job state in PostgreSQL
6. Emit real-time updates via WebSocket

### UI Service (`ultra-agent-ui`)
**Source**: `apps/ui`  
**Port**: Dynamic (Railway-assigned)  
**Dependencies**: API Service  

**Environment Variables**:
- `API_URL` → Railway API service reference
- `NODE_ENV` → Railway configuration

### Frontend (`apps/ui/src/index.html`)
**Purpose**: Single-page application with real-time updates  
**Features**: Job management, system monitoring, workspace display  
**WebSocket**: Dynamic connection to API service

### PostgreSQL Database (`Postgres`)
**Image**: `postgres:15-alpine`  
**Storage**: Persistent volume (`pg_data`)  
**Database**: `ultra_agent_os`  
**User**: `ultra_agent`  
**Password**: Railway-generated

### Redis Cache (`Redis`)
**Image**: `redis:7-alpine`  
**Storage**: Persistent volume (`redis_data`)  
**Purpose**: Job queuing and real-time state management

---

## DATABASE_SCHEMA

### Users Table:
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Jobs Table:
```sql
CREATE TABLE jobs (
  id VARCHAR(36) PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  type VARCHAR(100) NOT NULL,
  status VARCHAR(50) DEFAULT 'pending',
  input_data JSONB,
  output_data JSONB,
  error_message TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Memories Table:
```sql
CREATE TABLE memories (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  filename VARCHAR(255) NOT NULL,
  content JSONB NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, filename)
);
```

---

## BLUEPRINT_EXTENSION_POINTS

### Job Types:
Extend the worker to support new job types by modifying the `analyzeIntent` and `createPlan` functions in `/apps/worker/src/worker.js`.

### External Adapters:
- **LLM Integration**: Extend `callLLM` function for different providers
- **Container Runtime**: Extend Docker integration for other container systems
- **Storage Adapters**: Add new storage backends beyond PostgreSQL/Redis

### UI Components:
- **Custom Dashboards**: Add new sections to the frontend
- **Real-time Visualizations**: Extend WebSocket message handling
- **Authentication Methods**: Add OAuth, SAML, or other auth providers

### API Endpoints:
- **Custom Routes**: Add new API endpoints following authentication patterns
- **Middleware**: Add custom middleware for logging, rate limiting, etc.
- **Data Models**: Extend database schema with new tables/columns

---

## BLUEPRINT_DEPLOYMENT_REQUIREMENTS

### Minimum Resources:
- **CPU**: 1 core minimum, 2+ recommended
- **Memory**: 512MB minimum, 1GB+ recommended
- **Storage**: 1GB minimum for database and logs

### Railway Requirements:
- **Repository**: Public or private with Railway access
- **Build**: Nixpacks builder (configured in railway.toml)
- **Services**: All 5 services automatically provisioned
- **Environment**: All variables auto-generated or referenced

### Network Requirements:
- **API Port**: Dynamic (Railway-assigned); bind **HOST=0.0.0.0** in deployment
- **WebSocket Port**: From **WS_PORT** env (default 3011); no hardcoded port
- **Database Access**: PostgreSQL connectivity via service reference
- **Redis Access**: Redis connectivity via service reference

---

## BLUEPRINT_SECURITY_CONSIDERATIONS

### Authentication:
- JWT tokens with 24-hour expiration
- Password hashing with bcrypt (10 rounds)
- User isolation in all database queries

### Input Validation:
- XSS prevention in chat messages
- Filename validation for memory storage
- Length limits on all inputs

### Connection Security:
- Database connection pooling
- Redis connection validation
- WebSocket connection management

### Railway Security:
- Auto-generated secrets for JWT and API keys
- Service-to-service communication via internal URLs
- No hardcoded credentials in configuration

---

## BLUEPRINT_MONITORING_AND_HEALTH

### Health Checks:
- `GET /health` - Comprehensive system health
- Database connectivity testing
- Redis connectivity testing
- WebSocket server status

### Logging:
- Structured logging with component prefixes
- Error tracking with context
- Performance metrics for job execution

### Railway Monitoring:
- Service health metrics
- Resource usage tracking
- Deployment logs

---

## BLUEPRINT_USAGE_EXAMPLES

### One-Click Deployment:
1. Connect Railway to repository
2. Select repository for deployment
3. All services automatically provision and wire
4. Access UI via Railway-provided URL

### Custom Job Type:
```javascript
// In worker.js - extend analyzeIntent function
async function analyzeIntent(message) {
  // Add custom intent analysis
  if (message.includes('deploy')) {
    return { intent: 'deploy', confidence: 0.9 };
  }
  // ... existing logic
}
```

### Custom API Endpoint:
```javascript
// In server.js - add new endpoint
app.get('/api/custom', authenticateToken, async (req, res) => {
  // Custom logic with user isolation
  const result = await db.query('SELECT * FROM custom WHERE user_id = $1', [req.user.userId]);
  res.json(result.rows);
});
```

---

## BLUEPRINT_VERSION_HISTORY

### v1.0.0 (core-freeze-v1.0.0)
- Freeze Lock applied per GOVERNED_CORE_FREEZE_AND_EXPANSION_ORCHESTRATOR
- Locked directories: apps/api, apps/worker, lib, config
- API/DB schema changes prohibited on core tables
- Zero-trust autowire compliance; no hardcoded ports or URLs
- Real PostgreSQL and Redis integration; rate limiter surfaces 503 on Redis failure
- Worker Docker execution real when DOCKER_HOST set
- Forensic score: 96/100 (Phase 0 post-fix)

---

## BLUEPRINT_SUPPORT_AND_MAINTENANCE

### Core Stability:
This frozen core is designed for Railway blueprint stability and reusability. All core components are production-tested and forensically validated.

### Extension Guidelines:
1. **Preserve Blueprint Contracts**: Maintain Railway compatibility
2. **Follow Security Patterns**: Use existing authentication and validation
3. **Extend, Don't Modify**: Add new features without breaking existing ones
4. **Test Thoroughly**: Ensure extensions maintain forensic score

### Railway-Specific Considerations:
- All service references must use Railway service names
- Environment variables must be properly referenced
- No hardcoded URLs or ports
- Maintain zero-trust deployment capability

---

## BLUEPRINT_CERTIFICATION

### Railway Blueprint Certified:
- ✅ Zero-Trust Import Gate Passed
- ✅ All Services Auto-Provision
- ✅ All Services Auto-Wire
- ✅ Zero Manual Intervention Required
- ✅ Deterministic Deployment Outcome

### Production Ready:
- ✅ Real database integration
- ✅ Real-time processing
- ✅ Comprehensive security
- ✅ Live monitoring
- ✅ Extensible architecture

---

**END OF BLUEPRINT CORE CONTRACT**
