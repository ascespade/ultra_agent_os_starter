# Railway Deployment Checklist

## Configuration Status Table

| Service | Configuration File | Docker Valid | Env Vars OK | Status |
|---------|-------------------|--------------|-------------|--------|
| ultra-agent-api | `railway.toml:32-75` | ✅ | ✅ | READY |
| ultra-agent-worker | `railway.toml:78-114` | ✅ | ✅ | READY |
| ultra-agent-ui | `railway.toml:5-29` | ✅ | ✅ | READY |

## Railway Configuration Files

| File | Status | Notes |
|------|--------|-------|
| `railway.toml` | ✅ Exists | Uses modern TOML format |
| `railway.json` | ❌ Not Used | Railway prefers TOML format |
| `.env.railway` | ✅ Exists | Reference file for env vars |

## Issues Found

### Fixed Issues

1. **`.env.railway:13`** - `OLLAMA_URL=http://localhost:11434`
   - **Problem:** localhost URL will fail on Railway deployment
   - **Fix:** Changed to empty string (optional service)
   - **Status:** ✅ Fixed

2. **`apps/worker/Dockerfile:21`** - Healthcheck port fallback
   - **Problem:** Used `process.env.PORT || 3004` but worker listens on PORT+1000
   - **Fix:** Simplified to use `process.env.PORT` directly
   - **Status:** ✅ Fixed

3. **`apps/worker/Dockerfile:23`** - Multiple ports exposed
   - **Problem:** `EXPOSE 3004 4004` exposed unnecessary ports
   - **Fix:** Changed to `EXPOSE ${PORT:-3004}`
   - **Status:** ✅ Fixed

4. **`railway.toml:86`** - Worker healthcheck port specification
   - **Problem:** Fixed port 3004 conflicts with Railway's dynamic PORT
   - **Fix:** Removed port specification (Railway auto-detects from EXPOSE)
   - **Status:** ✅ Fixed

### No Issues Found

- ✅ API Dockerfile uses `process.env.PORT || 8080` - Correct for Railway
- ✅ UI Dockerfile uses `process.env.PORT || 3003` - Correct for Railway
- ✅ railway.toml defines all 3 services: api, worker, ui
- ✅ Service discovery configured (WORKER_URL, API_URL references)
- ✅ PostgreSQL and Redis services defined in railway.toml
- ✅ All services use `dockerfile` field (correct for railway.toml format)
- ✅ No hardcoded localhost URLs in railway.toml
- ✅ Environment variable references use Railway service discovery

## Deployment Steps

### 1. Connect Railway to GitHub Repository

```bash
# Navigate to Railway dashboard
# Select "Deploy from GitHub repo"
# Select this repository: ultra_agent_os_starter
```

### 2. Configure Services

Railway will automatically detect services from `railway.toml`:

| Service | Source | Dockerfile |
|---------|--------|------------|
| ultra-agent-ui | `apps/ui` | `Dockerfile` |
| ultra-agent-api | Root | `apps/api/Dockerfile` |
| ultra-agent-worker | Root | `apps/worker/Dockerfile` |
| Postgres | Image | `postgres:15-alpine` |
| Redis | Image | `redis:7-alpine` |

### 3. Set Environment Variables

Add these variables in Railway dashboard:

#### For ultra-agent-api:
- `NODE_ENV=production` (auto-set by railway.toml)
- `HOST=0.0.0.0` (auto-set by railway.toml)
- `PORT` (auto-assigned by Railway)
- `DATABASE_URL` (linked from Postgres service)
- `REDIS_URL` (linked from Redis service)
- `JWT_SECRET` (auto-generated by railway.toml)
- `INTERNAL_API_KEY` (auto-generated by railway.toml)
- `DEFAULT_ADMIN_PASSWORD` (auto-generated by railway.toml)
- `DATA_DIR=/data/agent` (auto-set by railway.toml)
- `OLLAMA_URL=` (optional, empty if not used)

#### For ultra-agent-worker:
- `NODE_ENV=production` (auto-set by railway.toml)
- `DATABASE_URL` (linked from Postgres service)
- `REDIS_URL` (linked from Redis service)
- `JWT_SECRET` (linked from ultra-agent-api)
- `INTERNAL_API_KEY` (linked from ultra-agent-api)
- `DATA_DIR=/data/agent` (auto-set by railway.toml)
- `OLLAMA_URL=` (optional, empty if not used)
- `WORKER_URL=http://ultra-agent-worker:${PORT}` (service discovery)

#### For ultra-agent-ui:
- `NODE_ENV=production` (auto-set by railway.toml)
- `PORT` (auto-assigned by Railway)
- `API_URL=https://${RAILWAY_PUBLIC_URL}/api` (linked from ultra-agent-api)

### 4. Deploy Services

```bash
# Using Railway CLI (optional)
railway login
railway init
railway up
```

Or deploy from Railway dashboard by clicking "Deploy" for each service.

### 5. Run E2E Tests

```bash
# After deployment, run E2E tests
API_URL=https://your-api-service.railway.app node scripts/e2e-real-test.js
```

## Post-Deployment Validation

### Health Check Commands

```bash
# API Health Check
curl https://your-api-service.railway.app/health

# Check API Logs
railway logs --service ultra-agent-api

# Check Worker Logs
railway logs --service ultra-agent-worker

# Check UI Logs
railway logs --service ultra-agent-ui
```

### Expected Health Check Responses

**API Service:**
```json
{"status":"healthy","service":"ultra-agent-api"}
```

**Worker Service:**
```json
{"status":"healthy","service":"ultra-agent-worker"}
```

**UI Service:**
```json
{"status":"healthy","service":"ultra-agent-ui"}
```

### Run E2E Tests

```bash
# Set API URL and run tests
export API_URL=https://your-api-service.railway.app
node scripts/e2e-real-test.js
```

## Service Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Railway Deployment                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │ ultra-agent-ui │───▶│ ultra-agent-api │───▶│     Worker    │  │
│  │    (Port 8080) │    │    (Port 8080) │    │  (Port 8080)  │  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
│         │                   │                   │            │
│         └───────────────────┴───────────────────┘            │
│                              │                               │
│         ┌────────────────────┼────────────────────┐          │
│         ▼                    ▼                    ▼          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │   Postgres    │    │    Redis     │    │   External   │  │
│  │  (pg_data)   │    │ (redis_data) │    │   Ollama     │  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## Troubleshooting

### Common Issues

1. **Worker health check failing**
   - Check that worker is listening on PORT environment variable
   - Verify `EXPOSE ${PORT:-3004}` in Dockerfile

2. **API cannot connect to database**
   - Verify DATABASE_URL is linked from Postgres service
   - Check logs: `railway logs --service ultra-agent-api`

3. **UI cannot reach API**
   - Verify API_URL is set to public URL of API service
   - Check service discovery: `WORKER_URL=http://ultra-agent-worker:${PORT}`

### View Logs

```bash
# All services
railway logs

# Specific service
railway logs --service ultra-agent-api
railway logs --service ultra-agent-worker
railway logs --service ultra-agent-ui
```

### Restart Service

```bash
railway restart --service ultra-agent-api
```

## Notes

- Railway uses dynamic PORT assignment; always use `process.env.PORT`
- Service discovery uses service names (e.g., `ultra-agent-worker`)
- Volumes persist PostgreSQL and Redis data
- Health checks configured in `railway.toml` for all services
